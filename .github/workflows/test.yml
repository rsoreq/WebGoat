name: "UI-Test"
on:
    pull_request:
        paths-ignore:
            - 'LICENSE'
            - 'docs/**'
    push:
        tags-ignore:
            - 'v*'
        paths-ignore:
            - '.txt'
            - '*.MD'
            - '*.md'
            - 'LICENSE'
            - 'docs/**'

jobs:
    build:
        runs-on: ubuntu-latest
        # display name of the job
        name: "Robot framework test"
        steps:
            # Uses an default action to checkout the code
            -   uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
            # Uses an action to add Python to the VM
            -   name: Setup Python
                uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
                with:
                    python-version: '3.7'
                    architecture: x64
            # Uses an action to add JDK 17 to the VM (and mvn?)
            -   name: set up JDK 17
                uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4
                with:
                    distribution: 'temurin'
                    java-version: 17
                    architecture: x64
            #Uses an action to set up a cache using a certain key based on the hash of the dependencies
            -   name: Cache Maven packages
                uses: actions/cache@13aacd865c20de90d75de3b17ebe84f7a17d57d2 # v4.0.0
                with:
                    path: ~/.m2
                    key: ubuntu-latest-m2-${{ hashFiles('**/pom.xml') }}
                    restore-keys: ubuntu-latest-m2-
            -   uses: BSFishy/pip-action@8f2d471d809dc20b6ada98c91910b6ae6243f318 # v1
                with:
                    packages: |
                        robotframework
                        robotframework-SeleniumLibrary
                        webdriver-manager
                        selenium==4.9.1
                    # TODO https://github.com/robotframework/SeleniumLibrary/issues/1835
            -   name: Run with Maven
                run: mvn --no-transfer-progress spring-boot:run &
            -   name: Wait to start
                uses: ifaxity/wait-on-action@a7d13170ec542bdca4ef8ac4b15e9c6aa00a6866 # v1
                with:
                    resource: http://127.0.0.1:8080/WebGoat
            -   name: Test with Robotframework
                run: python3 -m robot --variable HEADLESS:"1" --outputdir robotreport robot/goat.robot
            # send report to forks only due to limits on permission tokens
            -   name: Send report to commit
                if: github.repository != 'WebGoat/WebGoat' && github.event_name == 'push'
                uses: joonvena/robotframework-reporter-action@af55518ab58795993fd39e754efa038eb8659487 # v2.2
                with:
                    gh_access_token: ${{ secrets.GITHUB_TOKEN }}
                    report_path: 'robotreport'
